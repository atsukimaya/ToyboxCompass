<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>A-Frame WebAR | 固定位置のオレンジ球</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- A-Frame 本体 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        html, body {
            margin: 0;
            height: 100%;
            background: transparent;
            overflow: hidden;
        }
        /* ▼擬似AR用のビデオ（WebXR非対応 or 未突入時の背景） */
        #bgcam {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* 画面いっぱいにトリミング */
            z-index: 0; /* 一番背面 */
            background: #b6ff00; /* カメラが出ない時の保険色 */
        }
        /* A-Frameキャンバスを全画面に。背景α透過でカメラが透ける(WebXR AR) */
        a-scene {
            position: fixed;
            inset: 0;
        }
        /* 画面上に重ねるUI（任意） */
        #overlay {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            padding: 8px 12px;
            font: 14px/1.4 system-ui, sans-serif;
            color: #fff;
            text-shadow: 0 1px 2px #0008;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- ▼擬似AR用：端末カメラ映像。WebXRに入ると裏に隠れたままでも問題なし -->
    <video id="bgcam" playsinline autoplay muted></video>

    <!--
      A-Frameシーン設定
      - xr-mode-ui: 右下などに「Enter AR」ボタンを出す
      - webxr: AR機能を有効化（optionalFeaturesは端末によって無視される場合あり）
      - renderer: α透過（ARで実世界カメラが背景になる）
      - vr-mode-ui: VRボタンは不要なので無効化
    -->
    <a-scene xr-mode-ui="enabled: true"
             webxr="optionalFeatures: local-floor, dom-overlay; overlayElement: #overlay"
             renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true"
             vr-mode-ui="enabled: false">

        <!--
      カメラ。ユーザーの実世界の姿勢に同期。
      - look-controls: 端末の姿勢センサーで回転する
      - wasd-controls: キーボード移動は不要なので無効化
      ※ エンティティはカメラの子にしないこと。子にすると常に視点に追従してしまい、
         「ワールド固定」になりません。
    -->
        <a-entity camera look-controls wasd-controls-enabled="false"></a-entity>

        <!-- 環境光＆方向光（球にほどよい陰影をつける） -->
        <a-entity light="type: ambient; intensity: 0.6"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="0 4 2"></a-entity>

        <!--
      ★ オレンジ色の球体 ★
      - position="1 1.5 -3" が「ワールド座標での任意の位置」
        （ARセッション開始時の原点から x=+1m, y=+1.5m, z=-3m）
      - color / emissive で鮮やかなオレンジに
      - geometry で半径を調整
      - このエンティティはワールドに固定され、ユーザーが歩く/向きを変えると
        見える方向が変化します（＝その場に“浮いている”ように見える）
    -->
        <a-sphere id="sun" position="1 1.5 -3"
                  geometry="radius: 0.25; segmentsWidth: 32; segmentsHeight: 32"
                  material="color: #FF7F00; emissive: #9E4A00; metalness: 0.1; roughness: 0.5">
        </a-sphere>

        <!--任意のモデルを入れる-->
        <a-entity id="sunModel"
                  gltf-model="url(Duck.glb)"
                  position="0 1 -2" scale="0.2 0.2 0.2">

        </a-entity>
        <a-entity id="sunModel" gltf-model="url(https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Duck/glTF-Binary/Duck.glb)"
                  position="0 1 2" scale="0.2 0.2 0.2">


    </a-scene>

  
    <script>
        // ------------------------------------------------------------
        // ▼擬似AR：背面カメラを背景に再生
        // ------------------------------------------------------------
        (async () => {
            const video = document.getElementById('bgcam');
            try {
                // iOS/Safariでもなるべく背面カメラを使う
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                video.srcObject = stream;


                // 一部環境でautoplayが効かない場合があるため明示的にplay()
                const play = video.play();
                if (play && typeof play.catch === 'function') {
                    play.catch(() => {
                        // ユーザー操作後に play() すれば再生される想定
                        console.warn('自動再生に失敗。画面をタップすると再生される場合があります。');
                    });
                }
            } catch (err) {
                console.warn('カメラ取得に失敗:', err);
            }
        })();

        // 太陽の高度と方位（度）
        const altDeg = 45.7;
        const azDeg = 236;

        // ラジアンに変換
        const alt = altDeg * Math.PI / 180;
        const az = azDeg * Math.PI / 180;

        // 表示する距離（例：5m先）
        const R = 5;

        // 東(X), 上(Y), 北(Z) 成分を計算
        const x = Math.cos(alt) * Math.sin(az) * R;
        const y = Math.sin(alt) * R;
        const z = Math.cos(alt) * Math.cos(az) * R;

        // 球体のpositionをセット
        document.getElementById('sun').setAttribute('position', `${x} ${y} ${z}`);


        console.log("太陽の位置", x, y, z);

        // （任意）AR突入/離脱のログ
        /*
        const sceneEl = document.querySelector('a-scene');
        sceneEl.addEventListener('enter-vr', () => {
            if (sceneEl.is('ar-mode')) console.log('WebXR ARモード開始');
        });
        sceneEl.addEventListener('exit-vr', () => console.log('WebXR/VRモード終了'));
        */


    </script>
</body>
</html>
