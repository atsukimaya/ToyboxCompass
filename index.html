<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <title>A-Frame WebAR | 複数モデルを個別計算で配置</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- A-Frame 本体 -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        html, body {
            margin: 0;
            height: 100%;
            background: transparent;
            overflow: hidden;
        }
        /* ▼擬似AR用のビデオ（WebXR非対応 or 未突入時の背景） */
        #bgcam {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            background: #b6ff00;
        }
        /* A-Frameキャンバスを全画面に。背景α透過でカメラが透ける(WebXR AR) */
        a-scene {
            position: fixed;
            inset: 0;
        }
        /* 画面上に重ねるUI（任意） */
        #overlay {
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            padding: 8px 12px;
            font: 14px/1.4 system-ui, sans-serif;
            color: #fff;
            text-shadow: 0 1px 2px #0008;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- ▼擬似AR用：端末カメラ映像。WebXRに入ると裏に隠れたままでも問題なし -->
    <video id="bgcam" playsinline autoplay muted></video>

    <a-scene xr-mode-ui="enabled: true"
             webxr="optionalFeatures: local-floor, dom-overlay; overlayElement: #overlay"
             renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true"
             vr-mode-ui="enabled: false">

        <!-- ユーザーの視点カメラ（ワールド固定で置きたいので子要素は付けない） -->
        <a-entity camera look-controls wasd-controls-enabled="false"></a-entity>

        <!-- 環境光＆方向光 -->
        <a-entity light="type: ambient; intensity: 0.6"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="0 4 2"></a-entity>

        <!-- ▼オブジェクトたち（位置は script 内で計算して上書き） -->
        <!-- 1) 太陽：球体 -->
        <a-entity id="sun"
                  gltf-model="url(Duck.glb)"
                  scale="0.2 0.2 0.2" face-camera>
        </a-entity>

        <!-- 2) 土星：ローカルの saturn.glb を同ディレクトリに置く -->
        <a-entity id="saturn"
                  gltf-model="url(saturn.glb)"
                  scale="0.2 0.2 0.2" face-camera>
        </a-entity>

        <!-- 3) サンタ -->
        <a-entity id="santa"
                  gltf-model="url(santa.glb)"
                  scale="0.2 0.2 0.2" face-camera>
        </a-entity>
    </a-scene>

    <script>
        // ------------------------------------------------------------
        // ▼擬似AR：背面カメラを背景に再生
        // ------------------------------------------------------------
        (async () => {
            const video = document.getElementById('bgcam');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
                video.srcObject = stream;
                const play = video.play();
                if (play && typeof play.catch === 'function') {
                    play.catch(() => console.warn('自動再生に失敗。画面をタップすると再生される場合があります。'));
                }
            } catch (err) {
                console.warn('カメラ取得に失敗:', err);
            }
        })();

        // ------------------------------------------------------------
        // ▼複数モデルの「高度(°)・方位(°)・距離(m)」を個別に持たせる
        //   - selector: 配置対象のエンティティ（id などの CSS セレクタ）
        //   - altDeg : 地面からの角度（0°=水平, 90°=真上）
        //   - azDeg  : 方位角（0°=北, 90°=東, 180°=南, 270°=西） ※天文でよく使う定義
        //   - R      : 視点からの距離(m)
        // ------------------------------------------------------------
        const items = [
            { selector: '#sun', altDeg: 27.7, azDeg: 256, R: 5 }, // 例: 太陽
            { selector: '#saturn', altDeg: 50.6, azDeg: 162.9, R: 6 }, // 例: 土星
            { selector: '#santa', altDeg: -33.1, azDeg: 336.5, R: 4 }, // 例: サンタ
        ];

        // ------------------------------------------------------------
        // ▼高度・方位・距離 → ENU(東=+X, 上=+Y, 北=+Z) のワールド座標へ変換
        //   x = cos(alt) * sin(az) * R   (東)
        //   y = sin(alt) * R             (上)
        //   z = cos(alt) * cos(az) * R   (北)
        // ------------------------------------------------------------
        function altAzToPosition(altDeg, azDeg, R) {
            const alt = altDeg * Math.PI / 180;
            const az = azDeg * Math.PI / 180;
            const x = Math.cos(alt) * Math.sin(az) * R; // East
            const y = Math.sin(alt) * R;                // Up
            const z = Math.cos(alt) * Math.cos(az) * R; // North
            return { x, y, z };
        }

        // ------------------------------------------------------------
        // ▼一括配置：items を回して position を設定
        // ------------------------------------------------------------
        function placeAll() {
            for (const it of items) {
                const el = document.querySelector(it.selector);
                if (!el) { console.warn('要素が見つかりません:', it.selector); continue; }
                const { x, y, z } = altAzToPosition(it.altDeg, it.azDeg, it.R);
                el.setAttribute('position', `${x} ${y} ${z}`);
                // デバッグログ
                console.log(`[placed] ${it.selector}`, { altDeg: it.altDeg, azDeg: it.azDeg, R: it.R, x, y, z });
            }
        }

        // 3Dオブジェクトがカメラを向く
        AFRAME.registerComponent('face-camera', {
            tick: function () {
                const obj = this.el.object3D;
                const cam = this.el.sceneEl.camera;
                if (cam) {
                    obj.lookAt(cam.position); // カメラ位置を常に向く
                }
            }
        });


        // 初期配置（A-Frame が要素を初期化し終わった後に実行）
        window.addEventListener('load', () => {
            // シーンの準備ができてから配置を実行
            const scene = document.querySelector('a-scene');
            if (scene.hasLoaded) {
                placeAll();
            } else {
                scene.addEventListener('loaded', placeAll, { once: true });
            }
        });

        // ------------------------------------------------------------
        // ▼（任意）後から値を更新したい場合のユーティリティ
        //   updateItem('#saturn', { altDeg: 10, azDeg: 210, R: 8 })
        //   と呼べば、その要素だけ再配置されます。
        // ------------------------------------------------------------
        /*
        function updateItem(selector, patch) {
            const idx = items.findIndex(i => i.selector === selector);
            if (idx === -1) { console.warn('items に登録されていません:', selector); return; }
            items[idx] = { ...items[idx], ...patch };
            const { x, y, z } = altAzToPosition(items[idx].altDeg, items[idx].azDeg, items[idx].R);
            const el = document.querySelector(selector);
            if (el) el.setAttribute('position', `${x} ${y} ${z}`);
            console.log(`[updated] ${selector}`, items[idx], { x, y, z });
        
        }
        */
        // window に出してコンソールから触れるように（開発用）
        //window.updateItem = updateItem;

        // （任意）AR突入/離脱のログ
        /*
        const sceneEl = document.querySelector('a-scene');
        sceneEl.addEventListener('enter-vr', () => {
          if (sceneEl.is('ar-mode')) console.log('WebXR ARモード開始');
        });
        sceneEl.addEventListener('exit-vr', () => console.log('WebXR/VRモード終了'));
        */
    </script>
</body>
</html>
